name: Repo CI (just ci)

on:
  workflow_dispatch:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]
    paths-ignore:
      - "**/README.md"

concurrency:
  group: ci-${{ github.ref || github.run_id }}
  cancel-in-progress: true

jobs:
  ci:
    runs-on: ubuntu-24.04
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Install modern just
        run: |
          set -euo pipefail
          JUST_VERSION=1.30.0
          curl -fsSL https://github.com/casey/just/releases/download/${JUST_VERSION}/just-${JUST_VERSION}-x86_64-unknown-linux-musl.tar.gz \
            | tar -xz    
          sudo install -m 0755 just /usr/local/bin/just

      - name: Install CI deps
        run: |
          sudo apt-get update
          sudo apt-get install -y podman jq shellcheck shfmt

      - name: Configure podman storage
        run: |
          set -euo pipefail
          sudo mkdir -p /mnt/containers/storage
          sudo chown -R "$USER:$USER" /mnt/containers
          mkdir -p ~/.config/containers
          cat > ~/.config/containers/storage.conf <<'EOF'
          [storage]
          driver = "overlay"
          graphroot = "/mnt/containers/storage"
          runroot = "/tmp/containers-run"
          EOF
          mkdir -p /tmp/containers-run

      - name: Report podman storage
        run: |
          podman info

      - name: Normalize env (match repo conventions)
        run: |
          echo "IMAGE_NAME=${GITHUB_REPOSITORY##*/}" >> $GITHUB_ENV
          echo "DEFAULT_TAG=ci" >> $GITHUB_ENV

      - name: Run authoritative repo CI
        run: |
          just --list
          just ci
