name: Repo CI (just ci)

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]
    paths-ignore:
      - "**/README.md"

concurrency:
  group: ci-${{ github.ref || github.run_id }}
  cancel-in-progress: true

jobs:
  ci:
    runs-on: ubuntu-24.04
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Install dependencies
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y \
            just \
            podman \
            jq \
            shellcheck \
            shfmt

      - name: Normalize env (match repo conventions)
        run: |
          echo "IMAGE_NAME=${GITHUB_REPOSITORY##*/}" >> $GITHUB_ENV
          echo "DEFAULT_TAG=ci" >> $GITHUB_ENV

      - name: Run authoritative repo CI
        run: |
          just --list
          just ci
